#!/usr/bin/bash

# This is a systemd.generator(7) that automatically instantiates
# port-health-checker@.service and corresponding port-health-checker@.timer, to
# check connectivity to given port and address periodically. 
unitdir=/usr/lib/systemd/system

pkgname=@CMAKE_PROJECT_NAME@
pkgconfdir=/etc/${pkgname}
normal_dir=${1:-/tmp}  # /run/systemd/generator by default.


add_port_health_check_units () {
    conf=$1
    source ${conf}  # $PORT, $WANTS [, $ADDR, $AFTER, $OPTIONS]

    [[ ${PORT} =~ ^[0-9]+$ ]] || return  # $PORT is necessary.
    [[ ${ENABLED} =~ ^(1|y|t).*$ ]] || return  # Is it enabled?
    [[ -n ${WANTS} ]] || return  # $WANTS is necessary.

    wants="${WANTS}"
    after="${AFTER:-${WANTS}}"
    addr="${ADDR:-127.0.0.1}"  # TBU

    wants_dir=${normal_dir}/timers.target.wants
    conf_dir=${normal_dir}/${pkgname}@${PORT}.service.d
    mkdir -pm 0755 ${wants_dir} ${conf_dir}

    ln -sf "${unitdir}/${pkgname}@.service" "${normal_dir}/${pkgname}@${PORT}.service"
    ln -sf "${unitdir}/${pkgname}@.timer" "${wants_dir}/${pkgname}@${PORT}.timer"

    cat << EOF > ${conf_dir}/10-options.conf
# Generated by $0
[Unit]
Wants=${wants}
After=${after}
EOF
}

for cnf in ${pkgconfdir}/*.conf; do
    add_port_health_check_units ${cnf}
done

# vim:sw=4:ts=4:et:

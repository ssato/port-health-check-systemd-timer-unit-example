#!/usr/bin/bash

# This is a systemd.generator(7) that automatically instantiates
# port-health-checker@.service and corresponding port-health-checker@.timer, to
# check connectivity to given port and address periodically. 
unitdir=/usr/lib/systemd/system

pkgname=@CMAKE_PROJECT_NAME@
pkgconfdir=/etc/${pkgname}.d
normal_dir=${1:-/tmp}


add_port_health_check_units () {
    conf=$1
    source ${conf}  # $PORT, $REQUIRES [, $AFTER, $ADDR, $AFTER, $OPTIONS]

    [[ ${PORT} =~ ^[0-9]+$ ]] || return  # $PORT is necessary.
    [[ ${ENABLE} =~ ^(1|y|t).*$ ]] || return  # Is it enabled?

    # TODO: Define explicite dependecies to other service units on demand.
    # requires="${REQUIRES}"
    # after="${AFTER:-${requires}}"

    wants_dir=${normal_dir}/timers.target.wants

    # mkdir -pm 0755 ${wantsdir}
    ln -sf "${unitdir}/${pkgname}@.service" "${normal_dir}/${pkgname}@${PORT}.service"
    ln -sf "${unitdir}/${pkgname}@.timer" "${wantsdir}/${pkgname}@${PORT}.timer"
}

for cnf in ${pkgconfdir}/*.conf; do
    add_port_health_check_units ${cnf}
done

# vim:sw=4:ts=4:et:
